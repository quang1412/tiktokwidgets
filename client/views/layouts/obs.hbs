<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Overlay</title> 
    <link rel="stylesheet" href="style.css?">
    <link rel="stylesheet" href="/css/text-animation.css" />
    <link rel="stylesheet" href="/css/animate.css" />

    <style> 
      .message .name {
        opacity: 50%;
      }
      .message {
        margin-bottom: 9px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://kit.fontawesome.com/d83ecd5594.js" crossorigin="anonymous"></script> 
    <script src="/connection.js?t=12312312"></script>
    
    <!-- <script type="text/javascript">
    </script> -->

    <script type="text/javascript">
    (async function(){
      window.widgetid = '{{widgetid}}';
      window.setting = {
        {{#each setting}}
        "{{@key}}": "{{this}}",
        {{/each}} 
      } 

      console.log('widgetid:', window.widgetid)
      console.log('setting:', window.setting)

      let connection = new window.TikTokIOConnection(window.widgetid);

      connection.on('updateSetting', data => {
        window.setting = data
        
        console.log('setting:', window.setting)
      })

      $(document).ready(() => {
          $('#connectButton').click(connect);
          $('#uniqueIdInput').on('keyup', function (e) {
              if (e.key === 'Enter') {
                  connect();
              }
          });

          if (window.setting.username) connect();
      })
      
      connection.on('streamEnd', () => {
          $('#stateText').text('Stream ended.');

          // schedule next try if obs username set
          if (window.setting.username) {
              setTimeout(() => {
                  connect(window.setting.username);
              }, 30000);
          }
      }) 

      function connect() {
          let uniqueId = window.setting.username || $('#uniqueIdInput').val();
          if (uniqueId !== '') {

              $('#stateText').text('Connecting...');

              connection.connect(uniqueId, {
                  enableExtendedGiftInfo: true
              }).then(state => {
                  $('#stateText').text(`Connected to roomId ${state.roomId}`);
      

              }).catch(errorMessage => {
                  $('#stateText').text(errorMessage);

                  if (window.setting.username) {
                      setTimeout(() => {
                          connect(window.setting.username);
                      }, 30000);
                  }
              })

          } else {
              alert('no username entered');
          }
      } 
      
      $(document).ready(function(){  
        connection.on('like', (msg) => {
          const {userId} = msg 
        })  
      })

    })()
    </script> 
  </head>
  <body>
    <div style="">
      <div id="message-container" class="">
        {{!-- content --}}
      </div>
      <div id="stateText" ></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  </body>
</html>